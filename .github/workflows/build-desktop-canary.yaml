name: Build Desktop App (Canary)

on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git ref to build (branch, tag, or commit SHA)'
        required: false
        default: 'canary'
        type: string
      skip_windows:
        description: 'Skip Windows builds'
        required: false
        default: false
        type: boolean
      skip_macos:
        description: 'Skip macOS builds'
        required: false
        default: false
        type: boolean
      skip_linux:
        description: 'Skip Linux builds'
        required: false
        default: false
        type: boolean

permissions:
  contents: write

concurrency:
  group: build-desktop-canary-${{ inputs.ref || 'canary' }}
  cancel-in-progress: true

env:
  CHANNEL: canary
  SOURCE_REF: ${{ inputs.ref || 'canary' }}

jobs:
  matrix:
    name: Resolve platforms to build
    runs-on: ubuntu-24.04
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Set filtered matrix
        id: set-matrix
        run: |
          platforms='[
            {"platform":"windows","arch":"x64","os":"windows-latest","electron_arch":"x64"},
            {"platform":"windows","arch":"arm64","os":"windows-11-arm","electron_arch":"arm64"},
            {"platform":"macos","arch":"x64","os":"macos-15-intel","electron_arch":"x64"},
            {"platform":"macos","arch":"arm64","os":"macos-15","electron_arch":"arm64"},
            {"platform":"linux","arch":"x64","os":"ubuntu-24.04","electron_arch":"x64"},
            {"platform":"linux","arch":"arm64","os":"ubuntu-24.04-arm","electron_arch":"arm64"}
          ]'

          SKIP_WINDOWS="${{ inputs.skip_windows }}"
          SKIP_MACOS="${{ inputs.skip_macos }}"
          SKIP_LINUX="${{ inputs.skip_linux }}"

          node -e "const platforms = ${platforms}; const skipWin = '${SKIP_WINDOWS}' === 'true'; const skipMac = '${SKIP_MACOS}' === 'true'; const skipLinux = '${SKIP_LINUX}' === 'true'; const filtered = platforms.filter(p => !(skipWin && p.platform==='windows') && !(skipMac && p.platform==='macos') && !(skipLinux && p.platform==='linux')); console.log('matrix=' + JSON.stringify({include: filtered}));" >> "$GITHUB_OUTPUT"

  version:
    name: Bump Canary Version
    runs-on: ubuntu-24.04
    outputs:
      version: ${{ steps.bump.outputs.version }}
      pub_date: ${{ steps.bump.outputs.pub_date }}
    steps:
      - name: Checkout builds repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Calculate and push next tag
        id: bump
        run: |
          TAG_PREFIX="desktop-canary-v"
          TAG_GLOB="desktop-canary-v0.0.*"

          git fetch --tags --force

          LATEST=$(git tag -l "$TAG_GLOB" --sort=-v:refname | head -n1)
          NUM=0
          if [ -n "$LATEST" ]; then
            NUM=$(echo "$LATEST" | sed "s/${TAG_PREFIX}//" | cut -d. -f3)
          fi
          NUM=$((NUM + 1))

          VERSION="0.0.${NUM}"
          TAG_NAME="${TAG_PREFIX}${VERSION}"
          PUB_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "pub_date=${PUB_DATE}" >> "$GITHUB_OUTPUT"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "Tag $TAG_NAME already exists; skipping push"
          else
            git tag "$TAG_NAME"
            git push origin "$TAG_NAME"
          fi

          echo "Created tag: $TAG_NAME (version: $VERSION)"

  build:
    name: Build for ${{ matrix.platform }} (${{ matrix.arch }})
    needs: [version, matrix]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.matrix.outputs.matrix) }}

    steps:
      - name: Checkout private repository (Unix)
        if: runner.os != 'Windows'
        uses: actions/checkout@v6
        with:
          repository: fluxerapp-old/fluxer
          ref: ${{ env.SOURCE_REF }}
          ssh-key: ${{ secrets.FLUXER_PRIVATE_REPO_DEPLOY_KEY }}

      - name: Checkout private repository (Windows)
        if: runner.os == 'Windows'
        uses: actions/checkout@v6
        with:
          repository: fluxerapp-old/fluxer
          ref: ${{ env.SOURCE_REF }}
          token: ${{ secrets.FLUXER_PRIVATE_REPO_PAT }}

      - name: Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.22.0

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: pnpm
          cache-dependency-path: fluxer_app/pnpm-lock.yaml

      - name: Install Python distutils shim (Windows ARM64)
        if: matrix.platform == 'windows' && matrix.arch == 'arm64'
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          python -m pip install "setuptools>=69" wheel

      - name: Install dependencies
        working-directory: fluxer_app
        run: pnpm install --frozen-lockfile

      - name: Install Python setuptools (for node-gyp)
        if: matrix.platform == 'macos'
        run: brew install python-setuptools

      - name: Install Linux build dependencies (X11 + fpm + Flatpak)
        if: matrix.platform == 'linux'
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt-get update
          sudo apt-get install -y libx11-dev libxtst-dev libxt-dev libxinerama-dev libxkbcommon-dev libxrandr-dev ruby ruby-dev build-essential rpm flatpak flatpak-builder ostree libpixman-1-dev libcairo2-dev libpango1.0-dev libjpeg-dev libgif-dev librsvg2-dev
          sudo gem install --no-document fpm
          sudo flatpak remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo
          sudo flatpak install -y --noninteractive flathub org.freedesktop.Platform//24.08 org.freedesktop.Sdk//24.08

      - name: Update version in package.json
        working-directory: fluxer_app
        run: npm version ${{ needs.version.outputs.version }} --no-git-tag-version --allow-same-version

      - name: Build Electron main process
        working-directory: fluxer_app
        env:
          BUILD_CHANNEL: ${{ env.CHANNEL }}
        run: pnpm electron:compile

      - name: Build Electron app (macOS)
        if: matrix.platform == 'macos'
        working-directory: fluxer_app
        env:
          BUILD_CHANNEL: canary
          CSC_LINK: ${{ secrets.APPLE_CERTIFICATE }}
          CSC_KEY_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: pnpm exec electron-builder --config electron-builder.canary.yaml --mac --${{ matrix.electron_arch }}

      - name: Build Electron app (Windows)
        if: matrix.platform == 'windows'
        working-directory: fluxer_app
        env:
          BUILD_CHANNEL: canary
        run: pnpm exec electron-builder --config electron-builder.canary.yaml --win --${{ matrix.electron_arch }}

      - name: Build Electron app (Linux)
        if: matrix.platform == 'linux'
        working-directory: fluxer_app
        env:
          BUILD_CHANNEL: canary
          USE_SYSTEM_FPM: true
        run: pnpm exec electron-builder --config electron-builder.canary.yaml --linux --${{ matrix.electron_arch }}

      - name: Validate Flatpak AppStream metadata
        if: matrix.platform == 'linux'
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt-get install -y appstream
          APP_VERSION=$(node -e "console.log(require('./fluxer_app/package.json').version)")
          APP_RELEASE_DATE=$(date -u +%Y-%m-%d)
          mkdir -p fluxer_app/flatpak/build/appstream
          for appdata in app.fluxer.fluxer.metainfo.xml app.fluxer.fluxer.canary.metainfo.xml; do
            sed -e "s/@APP_VERSION@/${APP_VERSION}/g" -e "s/@APP_RELEASE_DATE@/${APP_RELEASE_DATE}/g" \
              "fluxer_app/flatpak/${appdata}" > "fluxer_app/flatpak/build/appstream/${appdata}"
            appstreamcli validate --pedantic "fluxer_app/flatpak/build/appstream/${appdata}"
          done

      - name: Build Flatpak package
        if: matrix.platform == 'linux'
        working-directory: fluxer_app
        env:
          CHANNEL: ${{ env.CHANNEL }}
          ARCHES: ${{ matrix.electron_arch }}
          FLATPAK_GPG_PRIVATE_KEY: ${{ secrets.FLATPAK_GPG_PRIVATE_KEY }}
          FLATPAK_GPG_PASSPHRASE: ${{ secrets.FLATPAK_GPG_PASSPHRASE }}
          FLATPAK_GPG_KEY_ID: ${{ secrets.FLATPAK_GPG_KEY_ID }}
        run: |
          chmod +x flatpak/build.sh
          ./flatpak/build.sh

      - name: Prepare artifacts
        shell: bash
        run: |
          mkdir -p upload_staging
          if [ -d "fluxer_app/dist-electron" ]; then
            cp -r fluxer_app/dist-electron/* upload_staging/ || true
          fi
          ls -la upload_staging/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fluxer-desktop-${{ env.CHANNEL }}-${{ matrix.platform }}-${{ matrix.arch }}
          path: |
            upload_staging/*.exe
            upload_staging/*.exe.blockmap
            upload_staging/*.dmg
            upload_staging/*.zip
            upload_staging/*.zip.blockmap
            upload_staging/*.AppImage
            upload_staging/*.deb
            upload_staging/*.tar.gz
            upload_staging/*.yml
            fluxer_app/flatpak/repo/**
          retention-days: 30

  upload:
    name: Upload builds to S3
    needs: [version, build]
    runs-on: ubuntu-24.04
    env:
      AWS_S3_ENDPOINT: https://s3.us-east-va.io.cloud.ovh.us
      AWS_S3_BUCKET: fluxer-dl
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: us-east-1
    steps:
      - name: Checkout private repository
        uses: actions/checkout@v6
        with:
          repository: fluxerapp-old/fluxer
          ref: ${{ env.SOURCE_REF }}
          ssh-key: ${{ secrets.FLUXER_PRIVATE_REPO_DEPLOY_KEY }}

      - name: Install Flatpak dependencies
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak ostree
          sudo flatpak remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo
          sudo flatpak install -y --noninteractive flathub org.freedesktop.Platform//24.08 org.freedesktop.Sdk//24.08

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Flatten artifact directories for uploader
        shell: bash
        run: |
          shopt -s nullglob dotglob
          for dir in artifacts/fluxer-desktop-${CHANNEL}-*; do
            if [ -d "$dir/upload_staging" ]; then
              mv "$dir"/upload_staging/* "$dir"/
              rmdir "$dir/upload_staging" || true
            fi
          done
          shopt -u nullglob dotglob

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'

      - name: Upload all builds to S3
        working-directory: scripts/ci/desktopci
        env:
          FLATPAK_GPG_PUBLIC_KEY: ${{ secrets.FLATPAK_GPG_PUBLIC_KEY }}
        run: |
          FLATPAK_ARGS=""
          if [ -n "${FLATPAK_GPG_PUBLIC_KEY}" ]; then
            FLATPAK_ARGS="--flatpak-gpg-public-key ${FLATPAK_GPG_PUBLIC_KEY}"
          fi
          go run . upload --channel "${CHANNEL}" --artifacts "${{ github.workspace }}/artifacts" --endpoint ${AWS_S3_ENDPOINT} --bucket ${AWS_S3_BUCKET} --version "${{ needs.version.outputs.version }}" --pub-date "${{ needs.version.outputs.pub_date }}" ${FLATPAK_ARGS}

      - name: Verify Flatpak publication
        env:
          CHANNEL: ${{ env.CHANNEL }}
        run: |
          set -euo pipefail
          APP_ID="app.fluxer.fluxer"
          [ "${CHANNEL}" = "canary" ] && APP_ID="app.fluxer.fluxer.canary"

          HEAD_FILE=$(find artifacts -path "*flatpak/repo/${CHANNEL}/refs/heads/app/${APP_ID}/x86_64/${CHANNEL}" | head -n 1)
          if [ -z "${HEAD_FILE}" ]; then
            echo "Head ref file not found in artifacts" >&2
            exit 1
          fi
          COMMIT=$(cat "${HEAD_FILE}")
          if [ -z "${COMMIT}" ]; then
            echo "Commit is empty in ${HEAD_FILE}" >&2
            exit 1
          fi

          echo "Verifying commit ${COMMIT} is in remote summary..."
          curl -fsSL "https://api.fluxer.app/dl/flatpak/${CHANNEL}/repo/summary" | strings | grep "${COMMIT}"
          echo "Commit found in summary!"

          echo "Verifying summary.sig exists..."
          curl -fsSL -o /dev/null -w "%{http_code}" "https://api.fluxer.app/dl/flatpak/${CHANNEL}/repo/summary.sig" | grep -q "200"
          echo "Summary signature file exists!"

      - name: Smoke install Flatpak from API
        env:
          CHANNEL: ${{ env.CHANNEL }}
        run: |
          set -euo pipefail
          sudo flatpak remote-delete fluxer-ci || true
          curl -fsSL "https://api.fluxer.app/dl/linux/x64/flatpak?channel=${CHANNEL}" -o /tmp/fluxer.flatpakref
          sudo flatpak install -y /tmp/fluxer.flatpakref
