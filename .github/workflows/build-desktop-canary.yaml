name: Build Desktop App (Canary)

on:
  workflow_dispatch:
    inputs:
      ref:
        description: Git ref to build (branch, tag, or commit SHA)
        required: false
        default: canary
        type: string
      skip_windows:
        description: Skip Windows builds
        required: false
        default: false
        type: boolean
      skip_macos:
        description: Skip macOS builds
        required: false
        default: false
        type: boolean
      skip_linux:
        description: Skip Linux builds
        required: false
        default: false
        type: boolean

permissions:
  contents: write

concurrency:
  group: desktop-canary-${{ inputs.ref || 'canary' }}
  cancel-in-progress: true

env:
  CHANNEL: canary
  SOURCE_REF: ${{ inputs.ref || 'canary' }}

jobs:
  matrix:
    name: Resolve build matrix
    runs-on: ubuntu-24.04
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Build platform matrix
        id: set-matrix
        run: |
          PLATFORMS='[
            {"platform":"windows","arch":"x64","os":"windows-latest","electron_arch":"x64"},
            {"platform":"windows","arch":"arm64","os":"windows-11-arm","electron_arch":"arm64"},
            {"platform":"macos","arch":"x64","os":"macos-15-intel","electron_arch":"x64"},
            {"platform":"macos","arch":"arm64","os":"macos-15","electron_arch":"arm64"},
            {"platform":"linux","arch":"x64","os":"ubuntu-24.04","electron_arch":"x64"},
            {"platform":"linux","arch":"arm64","os":"ubuntu-24.04-arm","electron_arch":"arm64"}
          ]'

          FILTERED=$(echo "$PLATFORMS" | jq -c --argjson skipWin "${{ inputs.skip_windows }}" --argjson skipMac "${{ inputs.skip_macos }}" --argjson skipLinux "${{ inputs.skip_linux }}" '
            [.[] | select(
              ((.platform == "windows") and $skipWin) or
              ((.platform == "macos") and $skipMac) or
              ((.platform == "linux") and $skipLinux)
              | not
            )]
          ')

          echo "matrix={\"include\":$FILTERED}" >> "$GITHUB_OUTPUT"

  version:
    name: Bump canary version
    runs-on: ubuntu-24.04
    outputs:
      version: ${{ steps.bump.outputs.version }}
      pub_date: ${{ steps.bump.outputs.pub_date }}
    steps:
      - name: Checkout builds repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Calculate next version
        id: bump
        run: |
          TAG_PREFIX="desktop-canary-v"
          git fetch --tags --force

          LATEST=$(git tag -l "${TAG_PREFIX}0.0.*" --sort=-v:refname | head -n1)
          NUM=0
          if [ -n "$LATEST" ]; then
            NUM=$(echo "$LATEST" | sed "s/${TAG_PREFIX}0.0.//" | cut -d. -f1)
          fi
          NUM=$((NUM + 1))

          VERSION="0.0.${NUM}"
          PUB_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "pub_date=$PUB_DATE" >> "$GITHUB_OUTPUT"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          TAG_NAME="${TAG_PREFIX}${VERSION}"
          if ! git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            git tag "$TAG_NAME"
            git push origin "$TAG_NAME"
          fi

          echo "Created tag: $TAG_NAME"

  build:
    name: Build ${{ matrix.platform }} (${{ matrix.arch }})
    needs: [version, matrix]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.matrix.outputs.matrix) }}
    env:
      APP_WORKDIR: fluxer_app
    steps:
      - name: Checkout source (Unix)
        if: runner.os != 'Windows'
        uses: actions/checkout@v6
        with:
          repository: fluxerapp-old/fluxer
          ref: ${{ env.SOURCE_REF }}
          ssh-key: ${{ secrets.FLUXER_PRIVATE_REPO_DEPLOY_KEY }}

      - name: Checkout source (Windows)
        if: runner.os == 'Windows'
        uses: actions/checkout@v6
        with:
          repository: fluxerapp-old/fluxer
          ref: ${{ env.SOURCE_REF }}
          token: ${{ secrets.FLUXER_PRIVATE_REPO_PAT }}

      - name: Shorten Windows paths (workspace + temp for Squirrel) and pin pnpm store
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          subst W: "$env:GITHUB_WORKSPACE"
          "APP_WORKDIR=W:\fluxer_app" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

          New-Item -ItemType Directory -Force "C:\t"        | Out-Null
          New-Item -ItemType Directory -Force "C:\sq"       | Out-Null
          New-Item -ItemType Directory -Force "C:\ebcache"  | Out-Null
          "TEMP=C:\t"               | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          "TMP=C:\t"                | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          "SQUIRREL_TEMP=C:\sq"     | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          "ELECTRON_BUILDER_CACHE=C:\ebcache" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

          New-Item -ItemType Directory -Force "C:\pnpm-store" | Out-Null
          "NPM_CONFIG_STORE_DIR=C:\pnpm-store" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          "npm_config_store_dir=C:\pnpm-store" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

          "store-dir=C:\pnpm-store" | Set-Content -Path "W:\.npmrc" -Encoding ascii

          git config --global core.longpaths true

      - name: Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.26.0

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20

      - name: Resolve pnpm store path (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $store = pnpm store path --silent
          "PNPM_STORE_PATH=$store" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          New-Item -ItemType Directory -Force $store | Out-Null

      - name: Resolve pnpm store path (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          store="$(pnpm store path --silent)"
          echo "PNPM_STORE_PATH=$store" >> "$GITHUB_ENV"
          mkdir -p "$store"

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ env.PNPM_STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: stable
          cache-dependency-path: fluxer_app/scripts/go.sum

      - name: Install Python setuptools (Windows ARM64)
        if: matrix.platform == 'windows' && matrix.arch == 'arm64'
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          python -m pip install "setuptools>=69" wheel

      - name: Install Python setuptools (macOS)
        if: matrix.platform == 'macos'
        run: brew install python-setuptools

      - name: Install Linux dependencies
        if: matrix.platform == 'linux'
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libx11-dev libxtst-dev libxt-dev libxinerama-dev libxkbcommon-dev libxrandr-dev \
            ruby ruby-dev build-essential rpm \
            libpixman-1-dev libcairo2-dev libpango1.0-dev libjpeg-dev libgif-dev librsvg2-dev
          sudo gem install --no-document fpm

      - name: Install dependencies
        working-directory: ${{ env.APP_WORKDIR }}
        run: pnpm install --frozen-lockfile

      - name: Update version
        working-directory: ${{ env.APP_WORKDIR }}
        run: pnpm version ${{ needs.version.outputs.version }} --no-git-tag-version --allow-same-version

      - name: Build Electron main process
        working-directory: ${{ env.APP_WORKDIR }}
        env:
          BUILD_CHANNEL: canary
        run: pnpm electron:compile

      - name: Build Electron app (macOS)
        if: matrix.platform == 'macos'
        working-directory: ${{ env.APP_WORKDIR }}
        env:
          BUILD_CHANNEL: canary
          CSC_LINK: ${{ secrets.APPLE_CERTIFICATE }}
          CSC_KEY_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: pnpm exec electron-builder --config electron-builder.canary.yaml --mac --${{ matrix.electron_arch }}

      - name: Build Electron app (Windows)
        if: matrix.platform == 'windows'
        working-directory: ${{ env.APP_WORKDIR }}
        env:
          BUILD_CHANNEL: canary
          TEMP: C:\t
          TMP: C:\t
          SQUIRREL_TEMP: C:\sq
          ELECTRON_BUILDER_CACHE: C:\ebcache
        run: pnpm exec electron-builder --config electron-builder.canary.yaml --win --${{ matrix.electron_arch }}

      - name: Analyze Squirrel nupkg for long paths
        if: matrix.platform == 'windows'
        working-directory: ${{ env.APP_WORKDIR }}
        shell: pwsh
        env:
          BUILD_VERSION: ${{ needs.version.outputs.version }}
          MAX_WINDOWS_PATH_LEN: 260
          PATH_HEADROOM: 10
        run: |
          $dirs = @(
            "dist-electron/squirrel-windows",
            "dist-electron/squirrel-windows-arm64"
          )

          $nupkg = $null
          foreach ($d in $dirs) {
            if (Test-Path $d) {
              $nupkg = Get-ChildItem -Path "$d/*.nupkg" -ErrorAction SilentlyContinue | Select-Object -First 1
              if ($nupkg) { break }
            }
          }

          if (-not $nupkg) {
            throw "No Squirrel nupkg found in: $($dirs -join ', ')"
          }

          Write-Host "Analyzing Windows installer $($nupkg.FullName)"
          $env:NUPKG_PATH = $nupkg.FullName

          $lines = @(
            'import os'
            'import zipfile'
            ''
            'path = os.environ["NUPKG_PATH"]'
            'build_ver = os.environ["BUILD_VERSION"]'
            'prefix = os.path.join(os.environ["LOCALAPPDATA"], "fluxer_app", f"app-{build_ver}", "resources", "app.asar.unpacked")'
            'max_len = int(os.environ.get("MAX_WINDOWS_PATH_LEN", "260"))'
            'headroom = int(os.environ.get("PATH_HEADROOM", "10"))'
            'limit = max_len - headroom'
            ''
            'with zipfile.ZipFile(path) as archive:'
            '    entries = []'
            '    for info in archive.infolist():'
            '        normalized = info.filename.lstrip("/\\\\")'
            '        total_len = len(os.path.join(prefix, normalized)) if normalized else len(prefix)'
            '        entries.append((total_len, info.filename))'
            ''
            'if not entries:'
            '    raise SystemExit("nupkg archive contains no entries")'
            ''
            'entries.sort(reverse=True)'
            'print(f"Assumed install prefix: {prefix} ({len(prefix)} chars). Maximum allowed path length: {limit} (total reserve {max_len}, headroom {headroom}).")'
            'print("Top 20 longest archived paths (length includes prefix):")'
            'for length, name in entries[:20]:'
            '    print(f"{length:4d} {name}")'
            ''
            'longest_len, longest_name = entries[0]'
            'if longest_len > limit:'
            '    raise SystemExit(f"Longest path {longest_len} for {longest_name} exceeds limit {limit}")'
            'print(f"Longest archived path {longest_len} is within the limit of {limit}.")'
          )

          $scriptPath = Join-Path $env:TEMP "nupkg-long-path-check.py"
          Set-Content -Path $scriptPath -Value $lines -Encoding utf8
          python $scriptPath

      - name: Build Electron app (Linux)
        if: matrix.platform == 'linux'
        working-directory: ${{ env.APP_WORKDIR }}
        env:
          BUILD_CHANNEL: canary
          USE_SYSTEM_FPM: true
        run: pnpm exec electron-builder --config electron-builder.canary.yaml --linux --${{ matrix.electron_arch }}

      - name: Prepare artifacts (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force upload_staging | Out-Null

          $dist = Join-Path $env:APP_WORKDIR "dist-electron"
          $sq = Join-Path $dist "squirrel-windows"

          if (Test-Path $sq) {
            Copy-Item -Force -ErrorAction SilentlyContinue "$sq\*.exe" "upload_staging\"
            Copy-Item -Force -ErrorAction SilentlyContinue "$sq\*.exe.blockmap" "upload_staging\"
            Copy-Item -Force -ErrorAction SilentlyContinue "$sq\RELEASES*" "upload_staging\"
            Copy-Item -Force -ErrorAction SilentlyContinue "$sq\*.nupkg" "upload_staging\"
            Copy-Item -Force -ErrorAction SilentlyContinue "$sq\*.nupkg.blockmap" "upload_staging\"
          }

          if (Test-Path $dist) {
            Copy-Item -Force -ErrorAction SilentlyContinue "$dist\*.yml" "upload_staging\"
            Copy-Item -Force -ErrorAction SilentlyContinue "$dist\*.zip" "upload_staging\"
            Copy-Item -Force -ErrorAction SilentlyContinue "$dist\*.zip.blockmap" "upload_staging\"
          }

          Get-ChildItem -Force upload_staging | Format-Table -AutoSize

      - name: Prepare artifacts (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          mkdir -p upload_staging
          DIST="${{ env.APP_WORKDIR }}/dist-electron"

          cp -f "$DIST"/*.dmg upload_staging/ 2>/dev/null || true
          cp -f "$DIST"/*.zip upload_staging/ 2>/dev/null || true
          cp -f "$DIST"/*.zip.blockmap upload_staging/ 2>/dev/null || true
          cp -f "$DIST"/*.yml upload_staging/ 2>/dev/null || true

          cp -f "$DIST"/*.AppImage upload_staging/ 2>/dev/null || true
          cp -f "$DIST"/*.deb upload_staging/ 2>/dev/null || true
          cp -f "$DIST"/*.tar.gz upload_staging/ 2>/dev/null || true

          ls -la upload_staging/

      - name: Normalize updater YAML (arm64)
        if: matrix.arch == 'arm64'
        shell: bash
        run: |
          cd upload_staging
          [[ "${{ matrix.platform }}" == "macos" && -f latest-mac.yml && ! -f latest-mac-arm64.yml ]] && mv latest-mac.yml latest-mac-arm64.yml || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fluxer-desktop-canary-${{ matrix.platform }}-${{ matrix.arch }}
          path: |
            upload_staging/*.exe
            upload_staging/*.exe.blockmap
            upload_staging/*.dmg
            upload_staging/*.zip
            upload_staging/*.zip.blockmap
            upload_staging/*.AppImage
            upload_staging/*.deb
            upload_staging/*.tar.gz
            upload_staging/*.yml
            upload_staging/*.nupkg
            upload_staging/*.nupkg.blockmap
            upload_staging/RELEASES*
          retention-days: 30

  upload:
    name: Upload to S3
    needs: [version, build]
    runs-on: ubuntu-24.04
    env:
      AWS_S3_ENDPOINT: https://s3.us-east-va.io.cloud.ovh.us
      AWS_S3_BUCKET: fluxer-downloads
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: us-east-1
    steps:
      - name: Checkout source repository
        uses: actions/checkout@v6
        with:
          repository: fluxerapp-old/fluxer
          ref: ${{ env.SOURCE_REF }}
          ssh-key: ${{ secrets.FLUXER_PRIVATE_REPO_DEPLOY_KEY }}

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: fluxer-desktop-canary-*

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: stable
          cache-dependency-path: fluxer_app/scripts/go.sum

      - name: Upload to S3
        working-directory: fluxer_app/scripts/cmd/desktopci
        run: |
          go run . upload \
            --channel "canary" \
            --artifacts "${{ github.workspace }}/artifacts" \
            --endpoint "$AWS_S3_ENDPOINT" \
            --bucket "$AWS_S3_BUCKET" \
            --version "${{ needs.version.outputs.version }}" \
            --pub-date "${{ needs.version.outputs.pub_date }}"

      - name: Build summary
        run: |
          {
            echo "## Desktop Canary Build Complete"
            echo ""
            echo "**Version:** ${{ needs.version.outputs.version }}"
            echo ""
            echo "[Download artifacts](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          } >> "$GITHUB_STEP_SUMMARY"
