name: Build Desktop App (Stable)

on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git ref to build (branch, tag, or commit SHA)'
        required: false
        default: 'stable'
        type: string
      skip_windows:
        description: 'Skip Windows builds'
        required: false
        default: false
        type: boolean
      skip_macos:
        description: 'Skip macOS builds'
        required: false
        default: false
        type: boolean
      skip_linux:
        description: 'Skip Linux builds'
        required: false
        default: false
        type: boolean

permissions:
  contents: write

concurrency:
  group: build-desktop-stable-${{ inputs.ref || 'stable' }}
  cancel-in-progress: true

env:
  CHANNEL: stable
  SOURCE_REF: ${{ inputs.ref || 'stable' }}

jobs:
  matrix:
    name: Resolve platforms to build
    runs-on: ubuntu-24.04
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Set filtered matrix
        id: set-matrix
        run: |
          set -euo pipefail
          PLATFORMS_JSON='[
            {"platform":"windows","arch":"x64","os":"windows-latest","electron_arch":"x64"},
            {"platform":"windows","arch":"arm64","os":"windows-11-arm","electron_arch":"arm64"},
            {"platform":"macos","arch":"x64","os":"macos-15-intel","electron_arch":"x64"},
            {"platform":"macos","arch":"arm64","os":"macos-15","electron_arch":"arm64"},
            {"platform":"linux","arch":"x64","os":"ubuntu-24.04","electron_arch":"x64"},
            {"platform":"linux","arch":"arm64","os":"ubuntu-24.04-arm","electron_arch":"arm64"}
          ]'

          SKIP_WINDOWS="${{ inputs.skip_windows }}"
          SKIP_MACOS="${{ inputs.skip_macos }}"
          SKIP_LINUX="${{ inputs.skip_linux }}"

          export PLATFORMS_JSON SKIP_WINDOWS SKIP_MACOS SKIP_LINUX
          node -e 'const platforms = JSON.parse(process.env.PLATFORMS_JSON); const skipWin = process.env.SKIP_WINDOWS === "true"; const skipMac = process.env.SKIP_MACOS === "true"; const skipLinux = process.env.SKIP_LINUX === "true"; const filtered = platforms.filter(p => !(skipWin && p.platform === "windows") && !(skipMac && p.platform === "macos") && !(skipLinux && p.platform === "linux")); process.stdout.write(`matrix=${JSON.stringify({include: filtered})}\\n`);' >> "$GITHUB_OUTPUT"

  version:
    name: Bump Stable Version
    runs-on: ubuntu-24.04
    outputs:
      version: ${{ steps.bump.outputs.version }}
      pub_date: ${{ steps.bump.outputs.pub_date }}
    steps:
      - name: Checkout builds repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Calculate and push next tag
        id: bump
        run: |
          set -euo pipefail
          TAG_PREFIX="desktop-stable-v"
          TAG_GLOB="desktop-stable-v0.0.*"

          git fetch --tags --force

          LATEST=$(git tag -l "$TAG_GLOB" --sort=-v:refname | head -n1)
          NUM=0
          if [ -n "$LATEST" ]; then
            NUM=$(echo "$LATEST" | sed "s/${TAG_PREFIX}//" | cut -d. -f3)
          fi
          NUM=$((NUM + 1))

          VERSION="0.0.${NUM}"
          TAG_NAME="${TAG_PREFIX}${VERSION}"
          PUB_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          printf 'version=%s\n' "$VERSION" >> "$GITHUB_OUTPUT"
          printf 'pub_date=%s\n' "$PUB_DATE" >> "$GITHUB_OUTPUT"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "Tag $TAG_NAME already exists; skipping push"
          else
            git tag "$TAG_NAME"
            git push origin "$TAG_NAME"
          fi

          echo "Created tag: $TAG_NAME (version: $VERSION)"

  build:
    name: Build for ${{ matrix.platform }} (${{ matrix.arch }})
    needs: [version, matrix]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.matrix.outputs.matrix) }}

    steps:
      - name: Checkout private repository (Unix)
        if: runner.os != 'Windows'
        uses: actions/checkout@v6
        with:
          repository: fluxerapp-old/fluxer
          ref: ${{ env.SOURCE_REF }}
          ssh-key: ${{ secrets.FLUXER_PRIVATE_REPO_DEPLOY_KEY }}

      - name: Checkout private repository (Windows)
        if: runner.os == 'Windows'
        uses: actions/checkout@v6
        with:
          repository: fluxerapp-old/fluxer
          ref: ${{ env.SOURCE_REF }}
          token: ${{ secrets.FLUXER_PRIVATE_REPO_PAT }}

      - name: Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.26.0

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: fluxer_app/pnpm-lock.yaml

      - name: Install Python distutils shim (Windows ARM64)
        if: matrix.platform == 'windows' && matrix.arch == 'arm64'
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          python -m pip install "setuptools>=69" wheel

      - name: Install dependencies
        working-directory: fluxer_app
        run: pnpm install --frozen-lockfile

      - name: Install Python setuptools (for node-gyp)
        if: matrix.platform == 'macos'
        run: brew install python-setuptools

      - name: Install Linux build dependencies (X11 + fpm)
        if: matrix.platform == 'linux'
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y libx11-dev libxtst-dev libxt-dev libxinerama-dev libxkbcommon-dev libxrandr-dev ruby ruby-dev build-essential rpm libpixman-1-dev libcairo2-dev libpango1.0-dev libjpeg-dev libgif-dev librsvg2-dev
          sudo gem install --no-document fpm

      - name: Update version in package.json
        working-directory: fluxer_app
        run: pnpm version ${{ needs.version.outputs.version }} --no-git-tag-version --allow-same-version

      - name: Build Electron main process
        working-directory: fluxer_app
        env:
          BUILD_CHANNEL: ${{ env.CHANNEL }}
        run: pnpm electron:compile

      - name: Build Electron app (macOS)
        if: matrix.platform == 'macos'
        working-directory: fluxer_app
        env:
          BUILD_CHANNEL: stable
          CSC_LINK: ${{ secrets.APPLE_CERTIFICATE }}
          CSC_KEY_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: pnpm exec electron-builder --config electron-builder.yaml --mac --${{ matrix.electron_arch }}

      - name: Build Electron app (Windows)
        if: matrix.platform == 'windows'
        working-directory: fluxer_app
        env:
          BUILD_CHANNEL: stable
        run: pnpm exec electron-builder --config electron-builder.yaml --win --${{ matrix.electron_arch }}

      - name: Build Electron app (Linux)
        if: matrix.platform == 'linux'
        working-directory: fluxer_app
        env:
          BUILD_CHANNEL: stable
          USE_SYSTEM_FPM: true
        run: pnpm exec electron-builder --config electron-builder.yaml --linux --${{ matrix.electron_arch }}

      - name: Prepare artifacts
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p upload_staging
          if [ -d "fluxer_app/dist-electron" ]; then
            cp -r fluxer_app/dist-electron/* upload_staging/ || true
          fi
          ls -la upload_staging/

      - name: Normalize updater YAML names (arm64)
        if: matrix.arch == 'arm64'
        shell: bash
        run: |
          set -euo pipefail
          cd upload_staging

          if [[ "${{ matrix.platform }}" == "macos" ]]; then
            [[ -f latest-mac.yml && ! -f latest-mac-arm64.yml ]] && mv latest-mac.yml latest-mac-arm64.yml
          fi

          if [[ "${{ matrix.platform }}" == "windows" ]]; then
            [[ -f latest.yml && ! -f latest-arm64.yml ]] && mv latest.yml latest-arm64.yml
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: fluxer-desktop-${{ env.CHANNEL }}-${{ matrix.platform }}-${{ matrix.arch }}
          path: |
            upload_staging/*.exe
            upload_staging/*.exe.blockmap
            upload_staging/*.dmg
            upload_staging/*.zip
            upload_staging/*.zip.blockmap
            upload_staging/*.AppImage
            upload_staging/*.deb
            upload_staging/*.tar.gz
            upload_staging/*.yml
          retention-days: 30

  upload:
    name: Upload builds to S3
    needs: [version, build]
    runs-on: ubuntu-24.04
    env:
      AWS_S3_ENDPOINT: https://s3.us-east-va.io.cloud.ovh.us
      AWS_S3_BUCKET: fluxer-dl
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: us-east-1
    steps:
      - name: Checkout private repository
        uses: actions/checkout@v6
        with:
          repository: fluxerapp-old/fluxer
          ref: ${{ env.SOURCE_REF }}
          ssh-key: ${{ secrets.FLUXER_PRIVATE_REPO_DEPLOY_KEY }}

      - name: Download all artifacts
        uses: actions/download-artifact@v5
        with:
          path: artifacts

      - name: Flatten artifact directories for uploader
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob dotglob
          for dir in artifacts/fluxer-desktop-${CHANNEL}-*; do
            if [ -d "$dir/upload_staging" ]; then
              mv "$dir"/upload_staging/* "$dir"/
              rmdir "$dir/upload_staging" || true
            fi
          done
          shopt -u nullglob dotglob

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: 'stable'

      - name: Upload all builds to S3
        working-directory: fluxer_app/scripts/cmd/desktopci
        run: |
          set -euo pipefail
          go run . upload --channel "${CHANNEL}" --artifacts "${{ github.workspace }}/artifacts" --endpoint "${AWS_S3_ENDPOINT}" --bucket "${AWS_S3_BUCKET}" --version "${{ needs.version.outputs.version }}" --pub-date "${{ needs.version.outputs.pub_date }}"
